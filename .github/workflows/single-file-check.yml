name: "Single File PR Check"

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  check-file-count:
    runs-on: ubuntu-latest
    env:
      # --- CONFIGURATION ---
      IGNORED_EXTENSIONS: "md|txt|png|jpg|svg" # Add extensions here
      BYPASS_LABEL: "bypass-limit"
      # ---------------------
    permissions:
      pull-requests: read
    steps:
      - name: Check for Bypass and File Count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh pr view ${{ github.event.pull_request.number }} -R ${{ github.repository }} --json labels,files)

          # 1. Check for bypass label
          if echo "$PR_DATA" | jq -r '.labels[].name' | grep -qi "^${{ env.BYPASS_LABEL }}$"; then
            echo "✅ Bypass label detected. Skipping check."
            exit 0
          fi

          # 2. Filter files and count
          # This JQ filter dynamically uses the IGNORED_EXTENSIONS variable
          FILE_COUNT=$(echo "$PR_DATA" | jq --arg exts "${{ env.IGNORED_EXTENSIONS }}" \
            '[.files[].path | select(test("\\.(" + $exts + ")$") | not)] | length')

          echo "Relevant files changed: $FILE_COUNT"

          if [ "$FILE_COUNT" -gt 1 ]; then
            echo "❌ Error: PR touches $FILE_COUNT code files. Only 1 is allowed."
            exit 1
          else
            echo "✅ Success!"
          fi
